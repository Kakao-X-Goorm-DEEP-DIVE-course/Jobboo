{% extends "base.html" %}

{% block content %}
<div class="main-content">
  <h2>팀 생성</h2>
  <form id="create-team-form" action="{{ url_for('create_team') }}" method="post" enctype="multipart/form-data"
    class="create-team-form" onsubmit="return validateFormBeforeSubmit(event)">
    <!-- 팀 이름 입력 -->
    <div class="form-group">
      <label for="t_name">팀 이름</label>
      <input type="text" id="t_name" name="t_name" required class="form-control" onblur="checkTeamName()">
      <div id="name_error" style="color: red; display: none;">이 팀 이름은 이미 사용중입니다.</div>
    </div>

    <!-- 팀 소개 입력 -->
    <div class="form-group">
      <label for="t_intro">팀 소개</label>
      <textarea id="t_intro" name="t_intro" rows="3" class="form-control"></textarea>
    </div>

    <!-- 팀 설명 입력 -->
    <div class="form-group">
      <label for="t_descript">팀 설명</label>
      <textarea id="t_descript" name="t_descript" rows="5" class="form-control"></textarea>
    </div>

    <!-- 팀 로고 업로드 -->
    <div class="form-group">
      <label for="t_logo">팀 로고</label>
      <input type="file" id="t_logo" name="t_logo" accept="image/*" class="form-control-file" onchange="previewLogo()">
    </div>

    <!-- 이미지 미리보기 -->
    <div class="form-group">
      <label>미리보기</label>
      <img id="logo-preview" src="#" alt="팀 로고 미리보기"
        style="display: none; max-width: 200px; max-height: 200px; margin-top: 10px;" onclick="openModal()">
    </div>

    <!-- GitHub URL 입력 -->
    <div class="form-group">
      <label for="t_git">팀 GitHub URL</label>
      <input type="url" id="t_git" name="t_git" class="form-control"
        placeholder="https://github.com/username/repository">
      <small id="t_git_error" style="color: red; display: none;">유효한 GitHub 주소를 입력하세요 (예:
        https://github.com/username/repository).</small>
    </div>

    <!-- 제출 버튼 -->
    <button type="submit" class="btn btn-primary" id="submit-btn">팀 생성</button>
  </form>
</div>

<!-- 이미지 클릭 시 큰 이미지 표시 모달 -->
<div id="imageModal" class="modal" onclick="closeModal(event)">
  <span class="close" onclick="closeModal()">&times;</span>
  <img class="modal-content" id="modal-image">
</div>

<!-- 자바스크립트 코드 -->
<script>
  let isNameValid = false;  // 팀 이름 유효성 확인 변수

  // 로고 미리보기 함수
  function previewLogo() {
    const file = document.getElementById('t_logo').files[0];
    const preview = document.getElementById('logo-preview');

    if (file) {
      const reader = new FileReader();
      reader.onload = function (e) {
        preview.src = e.target.result;
        preview.style.display = 'block';
      }
      reader.readAsDataURL(file);
    } else {
      preview.src = '#';
      preview.style.display = 'none';
    }
  }

  // 팀 이름 중복 검사 함수
  async function checkTeamName() {
    const nameInput = document.getElementById('t_name');
    const nameError = document.getElementById('name_error');
    const response = await fetch(`/team/check-name?name=${encodeURIComponent(nameInput.value)}`);
    const data = await response.json();

    if (data.exists) {
      nameError.style.display = 'block';
      isNameValid = false;  // 중복된 팀 이름일 경우 폼 제출 방지
    } else {
      nameError.style.display = 'none';
      isNameValid = true;  // 중복이 없으면 폼 제출 가능
    }
  }

  // 폼 제출 전 확인 함수
  async function validateFormBeforeSubmit(event) {
    event.preventDefault();  // 기본 제출 동작 막기

    await checkTeamName();  // 팀 이름 중복 검사 결과 기다리기

    // 팀 이름이 유효한 경우에만 폼 제출
    if (isNameValid) {
      document.getElementById('create-team-form').submit();  // 유효하면 폼 제출
    } else {
      console.log("중복된 팀 이름이 있어 폼이 제출되지 않았습니다.");
    }
  }

  // 모달 열기 함수
  function openModal() {
    const modal = document.getElementById('imageModal');
    const modalImg = document.getElementById('modal-image');
    const previewImg = document.getElementById('logo-preview');

    modal.style.display = "block";
    modalImg.src = previewImg.src;
  }

  // 모달 닫기 함수
  function closeModal(event) {
    const modal = document.getElementById('imageModal');
    if (event.target === modal || event.target.classList.contains('close')) {
      modal.style.display = "none";
    }
  }
</script>

<!-- 이 페이지에만 적용될 CSS 스타일 -->
<style>
  .create-team-form {
    max-width: 600px;
    margin: 0 auto;
    padding: 20px;
    background-color: #f9f9f9;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  }

  .create-team-form .form-group {
    margin-bottom: 20px;
  }

  .create-team-form label {
    font-weight: bold;
    display: block;
    margin-bottom: 10px;
    font-size: 1.1rem;
  }

  .create-team-form input[type="text"],
  .create-team-form input[type="url"],
  .create-team-form textarea {
    width: 100%;
    padding: 10px;
    font-size: 1rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    box-sizing: border-box;
    margin-top: 5px;
  }

  .create-team-form input[type="file"] {
    padding: 5px;
    font-size: 1rem;
  }

  .create-team-form .btn {
    background-color: #007bff;
    color: #fff;
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }

  .create-team-form .btn:hover {
    background-color: #0056b3;
  }

  .main-content {
    padding: 40px;
    background-color: #f0f8ff;
    border-radius: 8px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
  }

  #logo-preview {
    display: block;
    margin-top: 10px;
    max-width: 200px;
    max-height: 200px;
    cursor: pointer;
  }

  /* 모달 스타일 */
  .modal {
    display: none;
    position: fixed;
    z-index: 1;
    padding-top: 100px;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.6);
  }

  .modal-content {
    margin: auto;
    display: block;
    max-width: 80%;
    max-height: 80%;
  }

  .close {
    position: absolute;
    top: 15px;
    right: 35px;
    color: #fff;
    font-size: 40px;
    font-weight: bold;
    cursor: pointer;
  }

  .close:hover,
  .close:focus {
    color: #bbb;
    text-decoration: none;
    cursor: pointer;
  }
</style>
{% endblock %}